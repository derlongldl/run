<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>跑步訓練 PWA</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ff6a00">

  <style>
    :root{
      --bg:#fff6f0; --card:#fff; --text:#222; --accent:#ff6a00;
    }
    body{
      margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans CJK TC", "PingFang TC", "Helvetica Neue", Arial;
      background:var(--bg); color:var(--text); display:flex; flex-direction:column; align-items:center; padding:16px;
    }
    header{width:100%; max-width:520px;}
    h1{color:var(--accent); margin:6px 0 14px; font-size:20px;}
    .card{width:100%; max-width:520px; background:var(--card); border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.06); padding:14px; margin-bottom:12px;}
    .row{display:flex; align-items:center; gap:8px; flex-wrap:wrap;}
    .big{font-size:40px; font-weight:800;}
    .muted{color:#666; font-size:14px;}
    button{background:var(--accent); color:#fff; border:none; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer;}
    .smallBtn{background:#fff; color:var(--accent); border:1px solid #ffd0b8; padding:8px 12px;}
    .controls{display:flex; gap:8px; align-items:center; justify-content:center; margin-top:8px;}
    .number{font-weight:800; font-size:20px;}
    label{font-size:13px; color:#444;}
    .saved-list{max-height:220px; overflow:auto; margin-top:8px;}
    .save-row{display:flex; justify-content:space-between; padding:8px; border-bottom:1px dashed #eee;}
    .linklike{color:var(--accent); text-decoration:underline; background:none; border:none; padding:0; cursor:pointer;}
    footer{margin-top:12px; font-size:12px; color:#666;}
  </style>
</head>
<body>
  <header>
    <h1>跑步訓練 PWA（含 GPS & 步頻 170–230）</h1>
  </header>

  <section class="card">
    <div class="row" style="justify-content:space-between;">
      <div>
        <div class="muted">步頻（BPM）</div>
        <div id="cadence" class="big">170</div>
      </div>

      <div style="text-align:center;">
        <div class="muted">節拍</div>
        <div id="pulse" style="width:72px; height:72px; border-radius:36px; background:#fff0e6; margin:auto;"></div>
      </div>
    </div>

    <div class="controls" style="margin-top:12px;">
      <button class="smallBtn" onclick="changeCadence(-1)">－</button>
      <button onclick="changeCadence(1)">＋</button>
      <button id="toggleBeat" class="smallBtn" onclick="toggleMetronome()">開始節拍</button>
      <div style="margin-left:auto;">
        <label for="cadenceRange" class="muted">手動設定步頻</label><br/>
        <input id="cadenceRange" type="range" min="170" max="230" value="180" oninput="setCadenceFromRange(this.value)" />
      </div>
    </div>
  </section>

  <section class="card">
    <div class="row" style="justify-content:space-between;">
      <div>
        <div class="muted">? 時間</div>
        <div id="timeDisplay" class="number">00:00:00</div>
      </div>
      <div>
        <div class="muted">?? 距離（公里）</div>
        <div id="distanceDisplay" class="number">0.00</div>
      </div>
      <div>
        <div class="muted">?? 配速（分/公里）</div>
        <div id="paceDisplay" class="number">--:--</div>
      </div>
      <div>
        <div class="muted">?? 步頻</div>
        <div id="cadenceDisplaySmall" class="number">170</div>
      </div>
    </div>

    <div class="controls" style="margin-top:12px;">
      <button id="startBtn" onclick="startRun()">開始跑步</button>
      <button onclick="pauseRun()">暫停</button>
      <button onclick="stopRun()">結束並儲存</button>
      <button onclick="resetRun()" class="smallBtn">重設</button>
    </div>

    <div style="margin-top:10px;">
      <label class="muted">GPS 狀態：</label> <span id="gpsStatus" class="muted">尚未啟用</span>
    </div>
  </section>

  <section class="card">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div><strong>跑步紀錄</strong><div class="muted">本機儲存（localStorage）</div></div>
      <div>
        <button onclick="exportCSV()">匯出 CSV</button>
        <button onclick="clearRecords()" class="smallBtn">清空紀錄</button>
      </div>
    </div>

    <div class="saved-list" id="recordList"></div>
  </section>

  <footer>
    <div>備註：需在 HTTPS 或 localhost 下才能使用 GPS 與 PWA 安裝功能。</div>
  </footer>

<script>
/* ------------------------------
  主要變數與 UI 元件
-------------------------------*/
let cadence = 170;            
let metronomeTimer = null;
let audioCtx = null;

let runStart = null;         
let runElapsedSec = 0;       
let runTimer = null;
let watchId = null;
let lastPos = null;
let totalDistance = 0;       
let lastAnnouncedKm = 0;      // 新增：追蹤已播報的公里數

const cadenceEl = document.getElementById('cadence');
const cadenceSmall = document.getElementById('cadenceDisplaySmall');
const timeDisplay = document.getElementById('timeDisplay');
const distanceDisplay = document.getElementById('distanceDisplay');
const paceDisplay = document.getElementById('paceDisplay');
const gpsStatus = document.getElementById('gpsStatus');
const pulse = document.getElementById('pulse');

const RECORD_KEY = 'running_records_v1';

/* ---------- 語音播報功能 ---------- */
function announcePace(km, paceSec) {
  if (!('speechSynthesis' in window)) return;

  const mins = Math.floor(paceSec / 60);
  const secs = Math.round(paceSec % 60);
  
  // 播報文字內容
  const text = `達成 ${km} 公里，平均配速 ${mins} 分 ${secs} 秒。`;
  
  const msg = new SpeechSynthesisUtterance(text);
  msg.lang = 'zh-TW'; 
  msg.rate = 1.0;     
  msg.pitch = 1.0;    
  
  window.speechSynthesis.speak(msg);
}

/* ---------- 儲存/載入紀錄 ---------- */
function loadRecords(){
  const raw = localStorage.getItem(RECORD_KEY);
  try {
    return raw ? JSON.parse(raw) : [];
  } catch(e){
    console.warn('parse records err',e);
    return [];
  }
}
function saveRecord(record){
  const arr = loadRecords();
  arr.unshift(record); 
  localStorage.setItem(RECORD_KEY, JSON.stringify(arr));
  renderRecords();
}
function clearRecords(){
  if(!confirm('確定要清空所有本機跑步紀錄？')) return;
  localStorage.removeItem(RECORD_KEY);
  renderRecords();
}
function renderRecords(){
  const arr = loadRecords();
  const list = document.getElementById('recordList');
  list.innerHTML = '';
  if(arr.length===0){ list.innerHTML = '<div class="muted">尚無紀錄</div>'; return; }
  arr.forEach((r,i)=>{
    const div = document.createElement('div');
    div.className = 'save-row';
    div.innerHTML = `<div>
      <div style="font-weight:700;">${r.date}</div>
      <div class="muted">${r.duration} · ${r.distance} km · 平均配速 ${r.avgPace} · 步頻 ${r.cadence}</div>
    </div>
    <div>
      <button class="linklike" onclick="restoreRecord(${i})">回復</button>
      <button class="smallBtn" style="margin-left:8px;" onclick="deleteRecord(${i})">刪除</button>
    </div>`;
    list.appendChild(div);
  });
}
function deleteRecord(index){
  const arr = loadRecords();
  arr.splice(index,1);
  localStorage.setItem(RECORD_KEY, JSON.stringify(arr));
  renderRecords();
}
function restoreRecord(index){
  const arr = loadRecords();
  const r = arr[index];
  if(!r) return;
  alert('示範回復：將顯示該紀錄數據');
  timeDisplay.textContent = r.duration || '00:00:00';
  distanceDisplay.textContent = r.distance;
  paceDisplay.textContent = r.avgPace;
  cadenceSmall.textContent = r.cadence;
}

/* ---------- 匯出 CSV ---------- */
function exportCSV(){
  const arr = loadRecords();
  if(arr.length === 0){ alert('無紀錄可匯出'); return; }
  const header = ['日期','持續時間','距離(km)','平均配速','步頻(BPM)'];
  const rows = arr.map(r => [r.date, r.duration, r.distance, r.avgPace, r.cadence]);
  let csv = header.join(',') + '\n' + rows.map(r => r.map(cell => `"${cell}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'running_records.csv'; document.body.appendChild(a); a.click();
  a.remove(); URL.revokeObjectURL(url);
}

/* ---------- 步頻控制 & 節拍器 ---------- */
function updateCadenceUI(){
  cadenceEl.textContent = cadence;
  cadenceSmall.textContent = cadence;
  document.getElementById('cadenceRange').value = cadence;
}
function changeCadence(delta){
  cadence = Math.min(230, Math.max(170, cadence + delta));
  updateCadenceUI();
  if(metronomeTimer) startMetronome();
}
function setCadenceFromRange(val){
  cadence = Number(val);
  updateCadenceUI();
  if(metronomeTimer) startMetronome();
}
function startMetronome(){
  stopMetronome();
  if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  const intervalMs = 60000 / cadence;
  metronomeTimer = setInterval(() => {
    playBeep();
    pulse.style.transform = 'scale(0.85)';
    pulse.style.background = '#ff9066';
    setTimeout(()=>{ pulse.style.transform='scale(1)'; pulse.style.background='#fff0e6'; }, 120);
  }, intervalMs);
  document.getElementById('toggleBeat').textContent = '停止節拍';
}
function stopMetronome(){
  if(metronomeTimer) clearInterval(metronomeTimer);
  metronomeTimer = null;
  document.getElementById('toggleBeat').textContent = '開始節拍';
  pulse.style.background = '#fff0e6';
}
function toggleMetronome(){
  if(metronomeTimer) stopMetronome(); else startMetronome();
}
function playBeep(){
  if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = 'sine'; o.frequency.value = 1200;
  g.gain.value = 0.8;
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.08);
  o.stop(audioCtx.currentTime + 0.09);
}

/* ---------- GPS 與跑步計算 ---------- */
function haversine(lat1, lon1, lat2, lon2){
  const R = 6371000; 
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function startRun(){
  if(runTimer) { alert('已在跑步中'); return; }
  runStart = Date.now();
  runElapsedSec = 0;
  totalDistance = 0;
  lastPos = null;
  lastAnnouncedKm = 0; // 重置語音播報紀錄
  updateDisplays();

  runTimer = setInterval(()=>{ runElapsedSec = Math.floor((Date.now() - runStart)/1000); updateDisplays(); }, 1000);

  if('geolocation' in navigator){
    gpsStatus.textContent = '嘗試取得定位...';
    watchId = navigator.geolocation.watchPosition(pos => {
      gpsStatus.textContent = '定位中 (準確度 ' + (pos.coords.accuracy ? Math.round(pos.coords.accuracy) + 'm':'?') + ')';
      const {latitude, longitude} = pos.coords;
      if(lastPos){
        const d = haversine(lastPos.latitude, lastPos.longitude, latitude, longitude);
        if(pos.coords.accuracy < 50 || d < 20) { 
          totalDistance += d;
        }
      }
      lastPos = {latitude, longitude, timestamp: pos.timestamp};
      updateDisplays();
    }, err => {
      gpsStatus.textContent = '定位失敗：' + err.message;
    }, {enableHighAccuracy:true, maximumAge:0, timeout:15000});
  } else {
    gpsStatus.textContent = '此裝置不支援定位';
  }

  if(!metronomeTimer) startMetronome();
}

function pauseRun(){
  if(!runTimer) return;
  clearInterval(runTimer);
  runTimer = null;
  if(watchId) { navigator.geolocation.clearWatch(watchId); watchId = null; }
  stopMetronome();
  gpsStatus.textContent = '已暫停';
}

function stopRun(){
  if(!runStart) return;
  if(runTimer) { clearInterval(runTimer); runTimer = null; }
  if(watchId) { navigator.geolocation.clearWatch(watchId); watchId = null; }
  if(metronomeTimer) stopMetronome();

  const elapsed = Math.floor((Date.now() - runStart)/1000);
  const km = (totalDistance/1000);
  const durationStr = formatDuration(elapsed);
  const avgPace = km>0 ? formatPace(elapsed / km) : '--:--';
  const rec = {
    date: new Date().toLocaleString(),
    duration: durationStr,
    distance: km.toFixed(2),
    avgPace: avgPace,
    cadence: cadence
  };
  saveRecord(rec);

  runStart = null;
  runElapsedSec = 0;
  lastPos = null;
  totalDistance = 0;
  lastAnnouncedKm = 0;
  gpsStatus.textContent = '已結束';
  alert('已儲存紀錄：' + rec.date + '，距離 ' + rec.distance + ' km');
}

function resetRun(){
  if(runTimer || runStart) {
    if(!confirm('正在跑步，確定要重設？')) return;
  }
  if(runTimer){ clearInterval(runTimer); runTimer=null; }
  if(watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; }
  if(metronomeTimer) stopMetronome();
  runStart = null; runElapsedSec = 0; totalDistance = 0; lastPos=null;
  lastAnnouncedKm = 0; // 重置語音播報紀錄
  updateDisplays();
  gpsStatus.textContent = '尚未啟用';
}

/* ---------- 顯示更新 ---------- */
function updateDisplays(){
  let elapsed = runStart ? Math.floor((Date.now()-runStart)/1000) : runElapsedSec;
  const h = String(Math.floor(elapsed / 3600)).padStart(2,'0');
  const m = String(Math.floor((elapsed % 3600)/60)).padStart(2,'0');
  const s = String(elapsed % 60).padStart(2,'0');
  timeDisplay.textContent = `${h}:${m}:${s}`;

  const km = totalDistance / 1000;
  distanceDisplay.textContent = km.toFixed(2);

  // --- 語音播報邏輯 ---
  const currentFullKm = Math.floor(km);
  if (currentFullKm > lastAnnouncedKm && currentFullKm > 0) {
    lastAnnouncedKm = currentFullKm;
    const paceSecPerKm = Math.floor(elapsed / km);
    announcePace(currentFullKm, paceSecPerKm);
  }

  if(km > 0.001){
    const paceSecPerKm = Math.floor(elapsed / km);
    paceDisplay.textContent = formatPace(paceSecPerKm);
  } else {
    paceDisplay.textContent = '--:--';
  }
  cadenceSmall.textContent = cadence;
}

/* ---------- 格式工具 ---------- */
function formatDuration(sec){
  const h = Math.floor(sec/3600);
  const m = Math.floor((sec%3600)/60);
  const s = sec % 60;
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}
function formatPace(paceSec){
  const m = Math.floor(paceSec/60);
  const s = Math.round(paceSec % 60);
  return `${m}:${String(s).padStart(2,'0')}`;
}

updateCadenceUI();
renderRecords();

</script>
</body>
</html>
